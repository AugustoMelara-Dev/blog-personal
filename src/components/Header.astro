---
import { getCollection } from "astro:content";
import Search from "./Search.tsx";
import MobileMenu from "./MobileMenu.tsx";
import ThemeToggle from "./ThemeToggle.tsx";

const currentPath = Astro.url.pathname;

const desktopNavLinks = [
  { href: "/blog", label: "Blog" },
  { href: "/frases", label: "Frases" },
  { href: "/biblia", label: "Biblia" },
  { href: "/mapa", label: "Mapa" },
];

const mobileNavLinks = [
  { href: "/blog", label: "Blog" },
  { href: "/frases", label: "Frases" },
  { href: "/biblia", label: "Biblia" },
  { href: "/series", label: "Series" },
  { href: "/tags/reflexiones", label: "Tags" },
  { href: "/mapa", label: "Mapa" },
  { href: "/empieza", label: "Empieza aquí" },
  { href: "/guardados", label: "Guardados" },
  { href: "/about", label: "Sobre mí" },
  { href: "/archivo", label: "Archivo" },
];

const posts = await getCollection("posts", ({ data }) => !data.draft);
const frases = await getCollection("frases");

const searchData = [
  ...posts.map((post) => ({
    id: `post-${post.slug}`,
    title: post.data.title,
    description: post.data.description,
    tags: post.data.tags || [],
    date: post.data.pubDate.toISOString(),
    type: "post" as const,
    url: `/blog/${post.slug}`,
  })),
  ...frases.map((frase) => ({
    id: `frase-${frase.id}`,
    title: `Frase sobre ${frase.data.categoria}`,
    description: frase.data.texto,
    tags: [frase.data.categoria],
    date: frase.data.fecha.toISOString(),
    type: "frase" as const,
    url: `/frases?cat=${frase.data.categoria}`,
  })),
];

// Helper para links activos
const isActive = (href: string) =>
  currentPath === href || (currentPath.startsWith(`${href}/`) && href !== "/");
---

<header
  class="h-[64px] bg-[#0a0a0a]/90 backdrop-blur-md border-b border-[#1a1a1a] sticky top-0 z-50 flex items-center justify-between"
  style="padding-left: max(2rem, calc((100vw - 1200px) / 2)); padding-right: max(2rem, calc((100vw - 1200px) / 2));"
>
  <!-- Logo Izquierda -->
  <a href="/" class="flex flex-col flex-shrink-0 group relative z-10">
    <div class="flex items-center tracking-tight leading-none mb-0.5">
      <span class="text-[#f5f5f5] font-[800] text-xl">Vito</span>
      <span class="text-lime-400 font-[800] text-xl">Logic</span>
      {
        import.meta.env.DEV && (
          <div
            class="ml-2 relative flex items-center justify-center group"
            title="Modo desarrollo"
          >
            <span class="animate-ping absolute inline-flex h-2 w-2 rounded-full bg-red-400 opacity-75" />
            <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500" />
          </div>
        )
      }
    </div>
    <span
      class="text-[#525252] text-[10px] uppercase tracking-[0.25em] font-medium leading-none"
    >
      por Augusto Melara
    </span>
  </a>

  <!-- Nav Centro (Desktop) -->
  <nav
    class="hidden lg:flex items-center gap-8 absolute left-1/2 -translate-x-1/2"
  >
    {
      desktopNavLinks.map(({ href, label }) => {
        const active = isActive(href);
        return (
          <a
            href={href}
            class={`relative text-sm transition-colors duration-150 py-2 ${
              active
                ? "text-[#f5f5f5] underline decoration-lime-400 decoration-2 underline-offset-4 font-medium"
                : "text-[#737373] hover:text-[#f5f5f5]"
            }`}
          >
            {label}
          </a>
        );
      })
    }
  </nav>

  <!-- Acciones Derecha -->
  <div class="flex items-center gap-2 md:gap-4 flex-shrink-0 z-10">
    <!-- Lupa (Search.tsx) -->
    <div class="[&>button]:text-[#525252] [&>button:hover]:text-lime-400">
      <Search client:load items={searchData} />
    </div>

    <!-- RSS -->
    <a
      href="/rss.xml"
      aria-label="Feed RSS"
      target="_blank"
      class="text-[#525252] hover:text-lime-400 transition-colors duration-150 p-2 hidden sm:block"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="18"
        height="18"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M4 11a9 9 0 0 1 9 9"></path>
        <path d="M4 4a16 16 0 0 1 16 16"></path>
        <circle cx="5" cy="19" r="1"></circle>
      </svg>
    </a>

    <!-- Theme Toggle -->
    <ThemeToggle client:load />

    <!-- Hamburger Menu (Mobile) -->
    <MobileMenu client:load currentPath={currentPath} links={mobileNavLinks} />
  </div>
</header>
