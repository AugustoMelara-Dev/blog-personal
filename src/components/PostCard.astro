---
import TagBadge from "./TagBadge.astro";
import { format } from "date-fns";
import { es } from "date-fns/locale";
import Icon from "./icons/Icon.tsx";
import type { CollectionEntry } from "astro:content";

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  tags: string[];
  readingTime: string;
  slug: string;
  featured?: boolean;
  quote?: string;
  versiculo?: string;
  index?: number;
  post?: CollectionEntry<"posts">;
  globalIndex?: number;
  totalPosts?: number;
  serieIndex?: number;
  totalInSerie?: number;
  showSerieLabel?: boolean;
}

const {
  title,
  description,
  pubDate,
  tags,
  readingTime,
  slug,
  featured,
  quote,
  versiculo,
  index = 0,
  post,
  globalIndex,
  totalPosts,
  serieIndex,
  totalInSerie,
  showSerieLabel = false,
} = Astro.props;

const formattedDate = format(pubDate, "d 'de' MMMM, yyyy", { locale: es });
// Fallback orderNum solo por si no viene el label global globalIndex de la home
const orderNum = globalIndex
  ? String(globalIndex).padStart(2, "0")
  : String(index).padStart(2, "0");
---

{
  featured ? (
    <a
      href={`/blog/${slug}`}
      class="group block bg-[#111111] border border-[#1f1f1f] rounded-xl border-l-[3px] border-l-lime-400 p-8 md:p-10 transition-all duration-300 hover:scale-[1.005] hover:border-lime-400/50 min-h-[280px] post-card post-card-featured"
    >
      <div class="flex flex-col md:flex-row gap-8">
        <div class="flex-[3] flex flex-col gap-4">
          <span class="inline-block self-start px-3 py-1 rounded bg-lime-400/10 text-lime-400 text-xs font-semibold uppercase tracking-widest">
            Destacado
          </span>

          <h3 class="text-2xl font-bold text-[#f5f5f5] leading-tight group-hover:text-lime-400 transition-colors duration-200 post-card-title">
            {title}
          </h3>

          {quote && (
            <div class="border-l-2 border-lime-400 pl-4">
              <p class="text-base italic text-[#a3a3a3] leading-relaxed">
                "{quote}"
              </p>
            </div>
          )}

          <p class="text-base text-[#737373] line-clamp-3 leading-relaxed">
            {description}
          </p>
        </div>

        <div class="flex-[2] flex flex-col gap-4 md:items-end md:text-right justify-between">
          <div>
            <time
              datetime={pubDate.toISOString()}
              class="block text-2xl font-bold text-[#2a2a2a]"
            >
              {format(pubDate, "dd")}
            </time>
            <span class="text-xs text-[#525252] uppercase tracking-wider">
              {format(pubDate, "MMMM yyyy", { locale: es })}
            </span>
          </div>

          <span class="text-xs text-[#525252]">{readingTime}</span>

          {tags.length > 0 && (
            <div class="flex flex-wrap gap-2 md:justify-end">
              {tags.map((tag) => (
                <TagBadge tag={tag} linked={false} />
              ))}
            </div>
          )}
        </div>
      </div>
    </a>
  ) : (
    <a
      href={`/blog/${slug}`}
      class="group block relative bg-[#0f0f0f] border border-[#1a1a1a] rounded-[10px] p-7 transition-all duration-200 hover:bg-[#141414] hover:border-[#2a2a2a] overflow-hidden post-card"
    >
      {/* Número global — solo en blog index */}
      {!showSerieLabel && globalIndex && (
        <span
          style="
          position: absolute;
          top: 1.2rem;
          right: 1.5rem;
          font-size: 3.5rem;
          font-weight: 900;
          color: #1a1a1a;
          line-height: 1;
          user-select: none;
          pointer-events: none;
        "
        >
          {String(globalIndex).padStart(2, "0")}
        </span>
      )}

      {/* Label de serie */}
      {showSerieLabel && serieIndex && (
        <span
          style="
          display: block;
          font-size: 0.7rem;
          text-transform: uppercase;
          letter-spacing: 0.15em;
          color: #525252;
          font-weight: 500;
          margin-bottom: 0.5rem;
        "
        >
          Parte {serieIndex} de {totalInSerie}
        </span>
      )}

      <h3 class="text-xl font-semibold text-[#f5f5f5] line-clamp-2 group-hover:text-lime-400 transition-colors duration-200 pr-12 post-card-title">
        {title}
      </h3>

      <p class="text-sm text-[#737373] line-clamp-2 mt-2 leading-relaxed">
        {description}
      </p>

      <div class="flex flex-wrap items-center gap-3 mt-4 text-xs text-[#525252]">
        <time datetime={pubDate.toISOString()} class="flex items-center gap-1">
          <Icon name="Calendar" size={12} color="#525252" client:load />{" "}
          {formattedDate}
        </time>
        <span class="text-[#1a1a1a]">·</span>
        <span class="flex items-center gap-1">
          <Icon name="Clock" size={12} color="#525252" client:load />{" "}
          {readingTime}
        </span>
        {tags.length > 0 && (
          <>
            <span class="text-[#1a1a1a]">·</span>
            {tags.map((tag) => (
              <span class="text-[#525252] flex items-center gap-1">
                <Icon name="Tag" size={12} color="#525252" client:load /> {tag}
              </span>
            ))}
          </>
        )}
      </div>
    </a>
  )
}
