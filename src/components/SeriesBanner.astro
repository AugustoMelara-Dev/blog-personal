---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";

interface Props {
  post: CollectionEntry<"posts">;
}

const { post } = Astro.props;

// Solo mostrar si el post tiene serie
const hasSerie = !!post.data.serie;

let totalEnSerie = 0;
let parteActual = 0;
let prevPost: CollectionEntry<"posts"> | undefined;
let nextPost: CollectionEntry<"posts"> | undefined;

if (hasSerie) {
  const allPosts = await getCollection(
    "posts",
    ({ data }) => data.draft !== true && data.serie === post.data.serie,
  );

  const sorted = allPosts.sort(
    (a, b) => (a.data.serieOrden ?? 0) - (b.data.serieOrden ?? 0),
  );

  totalEnSerie = sorted.length;
  parteActual = post.data.serieOrden ?? 1;

  prevPost = sorted.find((p) => (p.data.serieOrden ?? 0) === parteActual - 1);
  nextPost = sorted.find((p) => (p.data.serieOrden ?? 0) === parteActual + 1);
}
---

{
  hasSerie && (
    <div
      style="
    background: #111111;
    border: 1px solid #1f1f1f;
    border-left: 3px solid #a3e635;
    border-radius: 0 8px 8px 0;
    padding: 1rem 1.25rem;
    margin-bottom: 2rem;
  "
    >
      <p
        style="
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: #525252;
      margin: 0 0 0.5rem;
    "
      >
        Serie · {post.data.serie}
      </p>

      <div
        style="
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    "
      >
        {prevPost ? (
          <a
            href={`/blog/${prevPost.slug}`}
            style="
          font-size: 0.8rem;
          color: #737373;
          text-decoration: none;
          display: flex;
          align-items: center;
          gap: 0.25rem;
        "
          >
            ← {prevPost.data.title}
          </a>
        ) : (
          <span style="font-size:0.8rem;color:#2a2a2a;">← Primera parte</span>
        )}

        <span
          style="
        font-size: 0.8rem;
        color: #a3e635;
        font-weight: 600;
        margin: 0 auto;
      "
        >
          Parte {parteActual} de {totalEnSerie}
        </span>

        {nextPost ? (
          <a
            href={`/blog/${nextPost.slug}`}
            style="
          font-size: 0.8rem;
          color: #737373;
          text-decoration: none;
          display: flex;
          align-items: center;
          gap: 0.25rem;
        "
          >
            {nextPost.data.title} →
          </a>
        ) : (
          <span style="font-size:0.8rem;color:#2a2a2a;">Última parte →</span>
        )}
      </div>
    </div>
  )
}
