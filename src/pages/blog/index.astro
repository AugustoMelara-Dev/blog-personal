---
import BaseLayout from "../../layouts/BaseLayout.astro";
import PostCard from "../../components/PostCard.astro";
import AnimatedPost from "../../components/AnimatedPost.tsx";
import { getCollection } from "astro:content";
import readingTime from "reading-time";

const allPosts = await getCollection("posts", ({ data }) => !data.draft);

const posts = allPosts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const allTags = [...new Set(posts.flatMap((post) => post.data.tags))].sort();

// Identificar el caso destacado (index 0 con featured=true)
const firstIsFeatured = posts.length > 0 && posts[0].data.featured;
const gridPosts = firstIsFeatured ? posts.slice(1) : posts;
---

<BaseLayout title="Blog" description="Todas las entradas del blog">
  <div class="max-w-5xl mx-auto px-6 py-16 md:py-24">
    <!-- Hero -->
    <AnimatedPost client:load index={0}>
      <div class="mb-12">
        <div class="w-10 h-[3px] bg-lime-400 mb-6"></div>
        <h1 class="text-5xl font-black text-[#f5f5f5] mb-3">Blog</h1>
        <p class="text-[#525252]">
          {posts.length} ideas publicadas
        </p>
      </div>
    </AnimatedPost>

    <!-- Tag Filter (sticky) -->
    <div
      class="sticky top-[56px] z-30 bg-[#0a0a0a]/95 backdrop-blur border-b border-[#1a1a1a] -mx-6 px-6 py-4 mb-12"
    >
      <div class="flex items-center gap-2 overflow-x-auto tags-scroll pb-2">
        <a
          href="/blog"
          class="flex-shrink-0 text-xs px-4 py-2 rounded-full border transition-colors duration-200 bg-lime-400/15 text-lime-400 border-lime-400/30"
        >
          Todos
        </a>
        {
          allTags.map((tag) => (
            <a
              href={`/tags/${tag}`}
              class="flex-shrink-0 text-xs px-4 py-2 rounded-full border border-[#1f1f1f] text-[#525252] hover:border-[#2a2a2a] hover:text-[#a3a3a3] transition-colors duration-200"
            >
              {tag}
            </a>
          ))
        }
      </div>
    </div>

    <!-- Featured Post -->
    {
      firstIsFeatured && (
        <div class="mb-12">
          <AnimatedPost client:load index={1}>
            <PostCard
              title={posts[0].data.title}
              description={posts[0].data.description}
              pubDate={posts[0].data.pubDate}
              tags={posts[0].data.tags}
              readingTime={readingTime(posts[0].body || "").text.replace(
                "read",
                "lectura",
              )}
              slug={posts[0].slug}
              featured={true}
              quote={posts[0].data.quote}
              index={1}
            />
          </AnimatedPost>
        </div>
      )
    }

    <!-- Separator -->
    {
      firstIsFeatured && gridPosts.length > 0 && (
        <div class="relative mb-12">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-[#1a1a1a]" />
          </div>
          <div class="relative flex justify-center">
            <span class="bg-[#0a0a0a] px-6 text-xs text-[#525252] uppercase tracking-widest">
              MÃ¡s entradas
            </span>
          </div>
        </div>
      )
    }

    <!-- Posts Grid -->
    {
      gridPosts.length > 0 && (
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          {gridPosts.map((post, i) => {
            const index = firstIsFeatured ? i + 1 : i;
            return (
              <AnimatedPost client:load index={index + 2}>
                <PostCard
                  title={post.data.title}
                  description={post.data.description}
                  pubDate={post.data.pubDate}
                  tags={post.data.tags}
                  readingTime={readingTime(post.body || "").text.replace(
                    "read",
                    "lectura",
                  )}
                  slug={post.slug}
                  index={index + 1}
                />
              </AnimatedPost>
            );
          })}
        </div>
      )
    }
  </div>
</BaseLayout>

<style>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
