---
export const prerender = false;

import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import CopyButton from "../components/CopyButton.tsx";
import StoryGenerator from "../components/StoryGenerator.tsx";
import FrasesCounter from "../components/FrasesCounter.tsx";

const cat = Astro.url.searchParams.get("cat");
const todasFrases = await getCollection("frases");

// Ordenar por fecha descendente
todasFrases.sort((a, b) => b.data.fecha.valueOf() - a.data.fecha.valueOf());

// Seleccionar frase del día usando fecha actual como seed
const today = new Date();
const seed =
  today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
const randomIdx = Math.abs(seed) % todasFrases.length;
const fraseDelDia = todasFrases[randomIdx];

const frases = cat
  ? todasFrases.filter((f) => f.data.categoria === cat)
  : todasFrases;

const categorias = ["reflexiones", "poder", "biblia", "personas"];

// Función para generar las clases inyectables del filtro
const getFilterClass = (isActive: boolean) =>
  isActive
    ? "bg-lime-400/10 text-lime-400 border-lime-400/30"
    : "bg-[#111111] text-[#737373] border-transparent hover:border-[#1f1f1f] hover:text-[#a3a3a3]";
---

<BaseLayout title="Frases" description="Pensamientos cortos. Sin filtro.">
  <div class="px-6 py-16 md:py-24 max-w-7xl mx-auto">
    <header class="mb-8 text-center max-w-2xl mx-auto">
      <h1 class="text-4xl md:text-5xl font-bold text-[#f5f5f5] mb-4">Frases</h1>
      <p class="text-xl text-[#a3a3a3]">Pensamientos cortos. Sin filtro.</p>
    </header>

    <FrasesCounter client:load total={todasFrases.length} />

    <!-- Filtros -->
    <div class="flex flex-wrap justify-center gap-2 md:gap-3 mb-12 md:mb-16">
      <a
        href="/frases"
        class={`px-4 py-2 rounded-full border text-sm transition-colors duration-200 ${getFilterClass(!cat)}`}
      >
        Todas
      </a>
      {
        categorias.map((c) => (
          <a
            href={`/frases?cat=${c}`}
            class={`px-4 py-2 rounded-full border text-sm capitalize transition-colors duration-200 ${getFilterClass(cat === c)}`}
          >
            {c}
          </a>
        ))
      }
    </div>

    <!-- Frase del día -->
    {
      fraseDelDia && !cat && (
        <div class="mb-16 bg-[#111111] border border-lime-400/20 rounded-xl p-8 md:p-12 relative overflow-hidden">
          <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-lime-400/0 via-lime-400/50 to-lime-400/0" />
          <div class="inline-block px-3 py-1 mb-6 rounded-full bg-lime-400/10 text-lime-400 text-xs font-semibold uppercase tracking-wider">
            Frase del día
          </div>
          <p class="text-[clamp(1.5rem,4vw,2.5rem)] text-[#f5f5f5] font-medium leading-snug mb-8">
            "{fraseDelDia.data.texto}"
          </p>
          <div class="flex flex-wrap items-center gap-4">
            <StoryGenerator client:load texto={fraseDelDia.data.texto} />
            <CopyButton client:load text={fraseDelDia.data.texto} />
          </div>
        </div>
      )
    }

    <!-- Grid Masonry -->
    <div class="columns-1 sm:columns-2 lg:columns-3 gap-4 md:gap-6 frases-grid">
      {
        frases.map((frase) => (
          <div class="break-inside-avoid mb-6 bg-[#111111] border border-[#1f1f1f] rounded-lg p-6 flex flex-col justify-between hover:border-[#333] transition-colors duration-300 frase-card">
            <p class="text-lg text-[#f5f5f5] font-medium leading-relaxed mb-8">
              "{frase.data.texto}"
            </p>
            <div class="flex flex-wrap items-center justify-between mt-auto gap-4">
              <a
                href={`/frases?cat=${frase.data.categoria}`}
                class="inline-block text-xs px-2.5 py-1 rounded-md bg-bg-subtle text-text-subtle hover:bg-accent/10 hover:text-accent transition-colors duration-200"
              >
                #{frase.data.categoria}
              </a>
              <div class="flex flex-wrap items-center gap-2 md:gap-4">
                <StoryGenerator client:load texto={frase.data.texto} />
                <CopyButton client:load text={frase.data.texto} />
              </div>
            </div>
          </div>
        ))
      }
    </div>

    {
      frases.length === 0 && (
        <div class="text-center text-[#737373] mt-12">
          <p>No se encontraron frases en esta categoría.</p>
        </div>
      )
    }
  </div>
</BaseLayout>
